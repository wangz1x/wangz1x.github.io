---
title: hyperloglog
date: 2021-09-23 16:50:48
tags:
- hyperloglog
- redis
---

`redis`中的一种数据结构, 用于计数场景, 如统计某页面访问次数等

常规思维，可能在计数的时候就会考虑`Map`, `Set`等数据结构，将数据进行存储，实现去重的效果

这样做的话，计数所需要的内存空间就和数据本身息息相关

进一步，可能考虑使用`bitmap`等数据结构，即用位代替真实的数据，这样`100,000,000`条数据需要`12.5MB`的存储空间

虽然已经减少了很多，但需要的存储空间依然和数据总数息息相关

上述方式都是精准统计的

当数据量继续增加时，我们可能会想到是否一定要精准统计呢

能否类似与布隆过滤器那样，允许计数存在些许的误差

`HyperLogLog`作为`LogLog`的改进，主要是降低误差

`LogLog`的名字应该是和该算法的空间复杂度相关

下面对`redis`中该算法的实现作个概述

### 主要流程

1. 计算`hash`值

`hash`值为64位，前14位用作分桶的依据，后50位为抛硬币模拟

2. 分桶

一共`2^14=16384`个桶，每个桶有6个`bit`用于记录第一个1出现的位置，足够表示50

3. 更新桶

如果该条记录的后50位中，第一个1出现的位置更靠后，则更新该桶对应的1出现的位置

比如原本该桶记录值为4(表示一条xxxx1000的记录，第4位为1)，该条记录为xxxx100000, 则需要桶对应值应更新为6，否则不变

4. 计数

计算所有桶中元素个数的调和平均数，在乘以桶的个数和微调因子(0.72125左右)，即为最终计数值
